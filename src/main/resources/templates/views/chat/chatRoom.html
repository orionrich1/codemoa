<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">

<head>
    <title th:text="${room.name}"></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .chat-card { height: 75vh; }
        .msgArea { flex-grow: 1; overflow-y: auto; }
        .msg-system { color: #888; font-style: italic; text-align: center; }
    </style>
</head>

<div layout:fragment="content">
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card chat-card">
                    <div class="card-header text-center">
                        <h4 class="card-title mb-0" th:text="${room.name}"></h4>
                    </div>
                    <div class="card-body d-flex flex-column p-2">
                        <div id="msgArea" class="msgArea p-2 mb-2">
                            </div>
                        <div class="input-group">
                            <input type="text" class="form-control content" placeholder="메시지를 입력하세요...">
                            <button type="button" class="btn btn-primary sendBtn">전송</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const username = [[${username}]];
        const roomId = [[${room.roomId}]];
        let stompClient = null;

        function connect() {
            const socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // 1. 채팅방 전체 메시지 구독 (모두가 보는 채널)
                stompClient.subscribe('/sub/chat/room/' + roomId, function (chatMessage) {
                    showMessage(JSON.parse(chatMessage.body));
                });

                // 2. 과거 대화 기록을 수신할 개인 큐 구독 (나만 보는 채널)
                stompClient.subscribe('/user/queue/messages', function (chatMessage) {
                    showMessage(JSON.parse(chatMessage.body));
                });

                // 3. 입장 메시지 전송
                stompClient.send("/pub/chat/message", {}, JSON.stringify({
                    'type': 'ENTER', 'roomId': roomId, 'sender': username
                }));
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.send("/pub/chat/message", {}, JSON.stringify({
                    'type': 'QUIT', 'roomId': roomId, 'sender': username
                }));
                stompClient.disconnect();
            }
        }

        function sendMessage() {
            const messageInput = document.querySelector('.content');
            const message = messageInput.value.trim();
            if (message && stompClient) {
                stompClient.send("/pub/chat/message", {}, JSON.stringify({
                    'type': 'TALK', 'roomId': roomId, 'sender': username, 'message': message
                }));
                messageInput.value = '';
                messageInput.focus();
            }
        }

        function showMessage(message) {
            const msgArea = document.getElementById('msgArea');
            const newMsg = document.createElement('div');

            if (message.type === 'TALK') {
                newMsg.classList.add("msg-talk");
                newMsg.innerText = message.sender + ": " + message.message;
            } else if (message.type === 'ENTER' || message.type === 'QUIT') {
                newMsg.classList.add("msg-system");
                newMsg.innerText = message.message;
            }
            // 참고: 서버에서 보내준 과거 기록은 type이 'TALK'이므로, 위 if문에서 처리됩니다.
            msgArea.appendChild(newMsg);
            msgArea.scrollTop = msgArea.scrollHeight;
        }
        
        document.querySelector(".sendBtn").addEventListener("click", sendMessage);
        document.querySelector(".content").addEventListener("keydown", (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        window.onload = connect;
        window.onbeforeunload = disconnect;
    </script>
</th:block>
</html>