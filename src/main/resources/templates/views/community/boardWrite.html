<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layouts/default_layout}">

<div layout:fragment="content">
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-4">
                    <h2 class="fw-bold fs-2">새 글 작성</h2>
                </div>
                
                <div class="card">
                    <div class="card-body p-4 p-md-5">
                        <form id="writeForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="category" class="form-label fw-bold">카테고리</label> 
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="" disabled selected>카테고리를 선택하세요</option>
                                        <option value="Java">Java</option>
                                        <option value="Python">Python</option>
                                        <option value="JavaScript">JavaScript</option>
                                        <option value="Kotlin">Kotlin</option>
                                        <option value="자유">자유</option>
                                    </select>
                                </div>

                                <div id="pointsDiv" class="col-md-6" style="display: none;">
                                    <label for="stakedPoints" class="form-label fw-bold">질문 포인트</label>
                                    <select class="form-select" id="stakedPoints" name="stakedPoints">
                                        <option value="10">10 포인트</option>
                                        <option value="30">30 포인트</option>
                                        <option value="50">50 포인트</option>
                                        <option value="100">100 포인트</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <label for="title" class="form-label fw-bold">제목</label> 
                                    <input type="text" class="form-control" id="title" name="title" placeholder="제목을 입력하세요" required>
                                </div>

                                <div class="col-12">
                                    <label for="content" class="form-label fw-bold">내용</label>
                                    <div id="summernote"></div>
                                    <textarea id="content" name="content" style="display: none;"></textarea>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <a href="/list" class="btn btn-secondary">취소</a>
                                <button type="submit" class="btn btn-primary">저장하기</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        $(document).ready(function() {
            $('#summernote').summernote({
                dialogsInBody: true,
                placeholder: '내용을 입력하세요',
                tabsize: 2,
                height: 350,
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ]
            });
        });
    </script>
    
    <script>
        // 카테고리 변경 시 포인트 드롭다운 보이기/숨기기
        document.getElementById('category').addEventListener('change', function() {
            const pointsDiv = document.getElementById('pointsDiv');
            if (this.value === '자유' || this.value === '') {
                pointsDiv.style.display = 'none';
            } else {
                pointsDiv.style.display = 'block';
            }
        });

        // 폼 전송 로직
        document.getElementById('writeForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const summernoteContent = $('#summernote').summernote('code');
            document.getElementById('content').value = summernoteContent;

            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const content = document.getElementById('content').value;
            const stakedPoints = document.getElementById('stakedPoints').value;
            const categoryIsQuestion = document.getElementById('category').value !== '자유';

            const data = {
                title: title,
                category: category,
                content: content,
                stakedPoints: categoryIsQuestion ? parseInt(stakedPoints, 10) : 0
            };

            const token = document.querySelector("meta[name='_csrf']")?.content;
			const header = document.querySelector("meta[name='_csrf_header']")?.content;
			const headers = { 'Content-Type': 'application/json' };
			if (token && header) {
				headers[header] = token;
			}

            fetch('/api/boards', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    alert("게시글이 성공적으로 등록되었습니다.");
                    // 성공 시 게시판 목록의 첫 페이지로 이동합니다.
                    location.href = `/community/${category}?page=0`; 
                } else {
                    response.text().then(text => {
                         try {
                             const err = JSON.parse(text);
                             alert("게시글 등록 실패: " + (err.message || "알 수 없는 오류"));
                         } catch (e) {
                             alert("게시글 등록 실패: " + text);
                         }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("오류가 발생했습니다.");
            });
        });
    </script>
</th:block>
</html>